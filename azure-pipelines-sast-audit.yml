trigger: none
pr: none

parameters:
  - name: targetRepoUrl
    type: string
    default: ''

  - name: targetBranches
    type: string
    displayName: "Branches (comma-separated). Example: main,develop,release/1.0"
    default: 'main,develop'

  - name: outputCsvName
    type: string
    default: 'synopsys_sast_audit.csv'

pool:
  vmImage: ubuntu-latest

steps:
  # 1) Checkout the audit repo (this repo) so we can access the script
  - checkout: self
    fetchDepth: 1

  # 2) Validate branches, run audit sequentially, and append into ONE CSV
  - bash: |
      set -euo pipefail
      cd "$(Build.SourcesDirectory)"

      echo "Target repo URL  : ${{ parameters.targetRepoUrl }}"
      echo "Target branches  : ${{ parameters.targetBranches }}"
      echo "Output CSV name  : ${{ parameters.outputCsvName }}"
      echo

      # Script used (make sure this file exists in the audit repo)
      chmod +x synopsys_sast_audit_v2.sh

      # Start fresh each pipeline run
      rm -f "${{ parameters.outputCsvName }}"

      # Convert comma-separated list to array + trim spaces
      IFS=',' read -r -a BRANCHES <<< "${{ parameters.targetBranches }}"

      echo "Validating branches exist on remote..."
      VALID_BRANCHES=()

      for BR in "${BRANCHES[@]}"; do
        BR="$(echo "$BR" | xargs)"  # trim spaces
        [[ -z "$BR" ]] && continue

        # Validate branch exists
        if git ls-remote --heads "${{ parameters.targetRepoUrl }}" "$BR" | grep -q "refs/heads/$BR"; then
          echo "[OK]   $BR"
          VALID_BRANCHES+=("$BR")
        else
          echo "[WARN] $BR not found on remote. Skipping."
        fi
      done

      if [[ ${#VALID_BRANCHES[@]} -eq 0 ]]; then
        echo "[ERROR] None of the provided branches exist on remote. Exiting."
        exit 1
      fi

      echo
      echo "Branches to scan (validated): ${VALID_BRANCHES[*]}"
      echo

      # Loop branches sequentially
      for BR in "${VALID_BRANCHES[@]}"; do
        echo "============================================================"
        echo "Processing branch: $BR"
        echo "============================================================"

        rm -rf target-repo

        # Clone this branch
        git clone --depth 1 --branch "$BR" "${{ parameters.targetRepoUrl }}" target-repo

        # Run audit; script appends to the SAME CSV
        bash -x synopsys_sast_audit_v2.sh "target-repo" "${{ parameters.outputCsvName }}"
      done

      echo
      echo "============================================================"
      echo "Final consolidated CSV preview:"
      echo "============================================================"
      head -n 30 "${{ parameters.outputCsvName }}" || true

      echo
      echo "Count of DIRECT findings (found_type=direct only):"
      grep -c ',direct,' "${{ parameters.outputCsvName }}" || true
    displayName: "Audit multiple branches sequentially (comma-separated, single consolidated CSV)"

  # 3) Publish the consolidated CSV always
  - task: PublishPipelineArtifact@1
    condition: always()
    inputs:
      targetPath: '$(Build.SourcesDirectory)/${{ parameters.outputCsvName }}'
      artifact: 'synopsys-sast-audit-report'
      publishLocation: 'pipeline'
    displayName: "Publish consolidated audit CSV artifact (always)"
